<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Datos</title>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f8; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 1rem; }
        .container { width: 100%; max-width: 700px; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        select, input[type="text"], input[type="date"], input[type="number"] { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .global-fields { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        button { width: 100%; padding: 1rem; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; margin-bottom: 1.5rem; }
        th, td { text-align: left; padding: 0.8rem; border-bottom: 1px solid #ddd; }
        th { background-color: #f9f9f9; font-size: 0.9rem; }
        td { font-size: 0.9rem; }
        td input[type="number"] { padding: 0.5rem; margin-bottom: 0; }
        .hidden { display: none; }
        #user-info { display: flex; justify-content: space-between; align-items: center; text-align: center; margin-bottom: 1.5rem; color: #555; }
        #logout-btn { background-color: #6c757d; font-size: 0.8rem; padding: 0.5rem 1rem; width: auto; margin-bottom: 0; }
        #logout-btn:hover { background-color: #5a6268; }
        #loader { text-align: center; padding: 1rem; }
        .input-warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div id="app-container" class="hidden">
            <div id="user-info">
                <span id="welcome-message"></span>
                <button id="logout-btn">Cerrar Sesión</button>
            </div>
            
            <h1>Registro de Datos</h1>

            <form id="data-form">
                <div class="global-fields">
                    <div class="grid-2">
                        <div>
                            <label for="mes">Mes de Registro:</label>
                            <select id="mes" name="mes" required></select>
                        </div>
                        <div>
                            <label for="ano">Año de Registro:</label>
                            <input type="text" id="ano" name="ano" readonly required>
                        </div>
                    </div>
                    <label for="fecha-vacunacion">Fecha verificación vacunación:</label>
                    <input type="date" id="fecha-vacunacion" name="fecha-vacunacion" required>
                    <label for="fecha-valoracion">Fecha de valoración antropométrica:</label>
                    <input type="date" id="fecha-valoracion" name="fecha-valoracion" required>
                    <label for="fecha-pb">Fecha de medición perímetro braquial:</label>
                    <input type="date" id="fecha-pb" name="fecha-pb" required>
                </div>
                
                <label for="service-unit">Unidad de servicio:</label>
                <select id="service-unit" name="service-unit" required>
                    <option value="">Seleccione para cargar beneficiarios...</option>
                </select>

                <div id="loader" class="hidden">Cargando beneficiarios...</div>

                <table id="beneficiaries-table">
                    <thead>
                        <tr>
                            <th>Beneficiario</th>
                            <th>Documento</th>
                            <th>Peso (kg)</th>
                            <th>Talla (cm)</th>
                            <th>PB (cm)</th>
                        </tr>
                    </thead>
                    <tbody id="beneficiaries-table-body"></tbody>
                </table>

                <button type="submit">Enviar Registros</button>
            </form>
        </div>

        <div id="login-container">
            <h1>Bienvenido</h1>
            <p>Por favor, inicie sesión para registrar los datos.</p>
            <button data-netlify-identity-button></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const welcomeMessage = document.getElementById('welcome-message');
            const logoutBtn = document.getElementById('logout-btn');
            const unitSelector = document.getElementById('service-unit');
            const tableBody = document.getElementById('beneficiaries-table-body');
            const loader = document.getElementById('loader');
            const dataForm = document.getElementById('data-form');
            const monthSelector = document.getElementById('mes');
            const yearInput = document.getElementById('ano');
            const fechaValoracionInput = document.getElementById('fecha-valoracion');
            const fechaPbInput = document.getElementById('fecha-pb');

            const showApp = (isLoggedIn) => {
                loginContainer.classList.toggle('hidden', isLoggedIn);
                appContainer.classList.toggle('hidden', !isLoggedIn);
            };

            netlifyIdentity.on('login', user => {
                showApp(true);
                welcomeMessage.textContent = `Bienvenida, ${user.user_metadata.full_name || user.email}`;
                fetchServiceUnits();
                netlifyIdentity.close();
            });

            netlifyIdentity.on('logout', () => {
                showApp(false);
                welcomeMessage.textContent = '';
                unitSelector.innerHTML = '<option value="">Seleccione para cargar beneficiarios...</option>';
                tableBody.innerHTML = '';
            });

            logoutBtn.addEventListener('click', () => {
                netlifyIdentity.logout();
            });

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            yearInput.value = currentYear;
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelector.appendChild(option);
            });
            monthSelector.selectedIndex = currentMonth;

            fechaValoracionInput.addEventListener('input', () => {
                fechaPbInput.value = fechaValoracionInput.value;
                fechaPbInput.readOnly = true;
            });

            const currentUser = netlifyIdentity.currentUser();
            if (currentUser) {
                showApp(true);
                welcomeMessage.textContent = `Bienvenida, ${currentUser.user_metadata.full_name || currentUser.email}`;
                fetchServiceUnits();
            } else {
                showApp(false);
            }

            let audioContext;
            const playBeep = () => { /* ... código del sonido ... */ };

            async function getAuthHeaders() {
                const user = netlifyIdentity.currentUser();
                if (!user) return {};
                const token = await user.jwt();
                return { Authorization: `Bearer ${token}` };
            }

            async function fetchServiceUnits() {
                try {
		    debugger;
                    const headers = await getAuthHeaders();
                    const response = await fetch('/.netlify/functions/get-user-data', { headers });
                    if (!response.ok) throw new Error('Error al cargar las unidades.');
                    const units = await response.json();
                    unitSelector.innerHTML = '<option value="">Seleccione...</option>';
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        unitSelector.appendChild(option);
                    });
                } catch (error) {
                    console.error(error);
                    alert('No se pudieron cargar sus unidades de servicio.');
                }
            }

            async function fetchBeneficiaries(unitName) {
                if (!unitName) { tableBody.innerHTML = ''; return; }
                loader.classList.remove('hidden');
                tableBody.innerHTML = '';
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch(`/.netlify/functions/get-beneficiaries?unit=${unitName}`, { headers });
                    if (!response.ok) throw new Error('Error al cargar los beneficiarios.');
                    const beneficiaries = await response.json();
                    renderBeneficiaries(beneficiaries);
                } catch (error) {
                    console.error(error);
                    alert(`No se pudieron cargar los beneficiarios para ${unitName}.`);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            function renderBeneficiaries(beneficiaries) { /* ... código sin cambios ... */ }
            
            unitSelector.addEventListener('change', () => fetchBeneficiaries(unitSelector.value));
            
            tableBody.addEventListener('input', (event) => { /* ... código sin cambios ... */ });
            tableBody.addEventListener('change', (event) => { /* ... código sin cambios ... */ });

            dataForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                // ... (código de validación sin cambios) ...
                if (!isValid) { /* ... */ return; }
                
                const globalData = { /* ... */ };
                const records = [];
                rows.forEach(row => { /* ... */ });
                const submission = { /* ... */ };
                
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch('/.netlify/functions/save-attendance', {
                        method: 'POST',
                        headers: { ...headers, 'Content-Type': 'application/json' },
                        body: JSON.stringify(submission)
                    });
                    if (!response.ok) throw new Error('Respuesta del servidor no fue exitosa. Código: ' + response.status);
                    
                    alert('¡Datos guardados con éxito!');
                    // ... (código de limpieza del formulario sin cambios)
                
                } catch (error) {
                    console.error('Error al enviar:', error);
                    alert('No se pudieron guardar los datos. Revisa la consola para más detalles.');
                }
            });
        });
    </script>
</body>
</html>