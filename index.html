<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Datos</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f8; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 1rem; }
        .container { width: 100%; max-width: 700px; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        select, input[type="text"], input[type="date"], input[type="number"] { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 1rem; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .global-fields { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        button { width: 100%; padding: 1rem; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; margin-bottom: 1.5rem; }
        th, td { text-align: left; padding: 0.8rem; border-bottom: 1px solid #ddd; }
        th { background-color: #f9f9f9; font-size: 0.9rem; }
        td { font-size: 0.9rem; }
        td input[type="number"] { padding: 0.5rem; margin-bottom: 0; }
        .hidden { display: none; }
        #loader { text-align: center; padding: 1rem; }
        .input-warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div id="app-container">
            <h1>Registro de Datos</h1>
            <form id="data-form">
                <div class="global-fields">
                    <div class="grid-2">
                        <div>
                            <label for="mes">Mes de Registro:</label>
                            <select id="mes" name="mes" required></select>
                        </div>
                        <div>
                            <label for="ano">Año de Registro:</label>
                            <input type="text" id="ano" name="ano" readonly required>
                        </div>
                    </div>
                    <label for="fecha-vacunacion">Fecha verificación vacunación:</label>
                    <input type="date" id="fecha-vacunacion" name="fecha-vacunacion" required>
                    <label for="fecha-valoracion">Fecha de valoración antropométrica:</label>
                    <input type="date" id="fecha-valoracion" name="fecha-valoracion" required>
                    <label for="fecha-pb">Fecha de medición perímetro braquial:</label>
                    <input type="date" id="fecha-pb" name="fecha-pb" required>
                </div>
                
                <label for="service-unit">Unidad de servicio:</label>
                <select id="service-unit" name="service-unit" required>
                    <option value="">Cargando unidades...</option>
                </select>

                <div id="loader" class="hidden">Cargando beneficiarios...</div>

                <table id="beneficiaries-table">
                    <thead>
                        <tr>
                            <th>Beneficiario</th>
                            <th>Documento</th>
                            <th>Peso (kg)</th>
                            <th>Talla (cm)</th>
                            <th>PB (cm)</th>
                        </tr>
                    </thead>
                    <tbody id="beneficiaries-table-body"></tbody>
                </table>

                <button type="submit">Enviar Registros</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const unitSelector = document.getElementById('service-unit');
            const tableBody = document.getElementById('beneficiaries-table-body');
            const loader = document.getElementById('loader');
            const dataForm = document.getElementById('data-form');
            const monthSelector = document.getElementById('mes');
            const yearInput = document.getElementById('ano');
            const fechaValoracionInput = document.getElementById('fecha-valoracion');
            const fechaPbInput = document.getElementById('fecha-pb');

            // --- INICIALIZACIÓN DE CAMPOS ---
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            yearInput.value = currentYear;
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelector.appendChild(option);
            });
            monthSelector.selectedIndex = currentMonth;

            fechaValoracionInput.addEventListener('input', () => {
                fechaPbInput.value = fechaValoracionInput.value;
                fechaPbInput.readOnly = true;
            });
            
            // --- FUNCIONES Y LÓGICA ---
            let audioContext;
            const playBeep = () => { /* ... código del sonido ... */ };

            async function fetchServiceUnits() {
                try {
                    // La llamada ya no necesita cabeceras de autorización
                    const response = await fetch('/.netlify/functions/get-user-data');
                    if (!response.ok) throw new Error('Error al cargar las unidades.');
                    const units = await response.json();
                    unitSelector.innerHTML = '<option value="">Seleccione...</option>';
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        unitSelector.appendChild(option);
                    });
                } catch (error) {
                    console.error(error);
                    alert('No se pudieron cargar las unidades de servicio.');
                }
            }

            async function fetchBeneficiaries(unitName) {
                if (!unitName) { tableBody.innerHTML = ''; return; }
                loader.classList.remove('hidden');
                tableBody.innerHTML = '';
                try {
                    const response = await fetch(`/.netlify/functions/get-beneficiaries?unit=${unitName}`);
                    if (!response.ok) throw new Error('Error al cargar los beneficiarios.');
                    const beneficiaries = await response.json();
                    renderBeneficiaries(beneficiaries);
                } catch (error) {
                    console.error(error);
                    alert(`No se pudieron cargar los beneficiarios para ${unitName}.`);
                } finally {
                    loader.classList.add('hidden');
                }
            }
            
            function renderBeneficiaries(beneficiaries) { /* ...código sin cambios... */ }
            
            // Cargar las unidades de servicio en cuanto la página esté lista
            fetchServiceUnits();

            // --- EVENTOS DEL FORMULARIO ---
            unitSelector.addEventListener('change', () => fetchBeneficiaries(unitSelector.value));
            tableBody.addEventListener('input', (event) => { /* ... código de validación en tiempo real ... */ });
            tableBody.addEventListener('change', (event) => { /* ... código de alerta de desnutrición ... */ });

            dataForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                // ... (código de validación sin cambios) ...
                if (!isValid) { /* ... */ return; }
                
                const globalData = { /* ... */ };
                const records = [];
                rows.forEach(row => { /* ... */ });

                const submission = {
                    serviceUnit: unitSelector.value,
                    submissionDate: new Date().toISOString(),
                    submittedBy: "Formulario Público", // Cambiado
                    globalData: globalData,
                    records: records
                };
                
                try {
                    // La llamada ya no necesita cabeceras de autorización
                    const response = await fetch('/.netlify/functions/save-attendance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submission)
                    });
                    if (!response.ok) throw new Error('Respuesta del servidor no fue exitosa.');
                    
                    alert('¡Datos guardados con éxito!');
                    // ... (código de limpieza del formulario sin cambios)
                
                } catch (error) {
                    console.error('Error al enviar:', error);
                    alert('No se pudieron guardar los datos.');
                }
            });
        });
    </script>
</body>
</html>